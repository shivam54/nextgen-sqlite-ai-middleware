# Next-Gen SQLite: An AI-Augmented Intelligent Middleware for Efficient SQLite Querying

This project enhances SQLite with three major AI/ML features: intelligent cache management using neural networks, query optimization improvements, and anomaly detection resulting in significant performance improvements for complex database queries.

## Overview

This project implements three key enhancements to SQLite:

### 1. ML-Based Cache Management
We replaced SQLite's default LRU (Least Recently Used) cache eviction policy with a machine learning model that scores pages based on multiple factors:
- Access frequency
- Recency of access
- Dirty page status
- Active references

### 2. Query Optimization
Enhanced SQLite's query planner/optimizer to make smarter execution plan decisions:
- **Covering Index Detection:** Automatically detects and prefers covering indexes where the index contains all query columns, reducing I/O by skipping table lookups
- Improved candidate loop plan generation for each table
- Enhanced cost estimation algorithms with cost discounts for covering plans
- Better index selection and join ordering
- **Full Compatibility:** Works automatically without requiring SQL changes

### 3. Anomaly Detection
Implemented anomaly detection system for cache access patterns using:
- Z-Score statistical analysis
- Isolation Forest machine learning algorithm
- Real-time detection of unusual access patterns

**Result:** 83.7% faster performance on complex TPC-H queries.

## Project Structure

### Core Implementation - Cache Management
- `sqlite-src-3510000/src/pcache1.c` - Modified SQLite page cache with ML eviction logic
- `sqlite-src-3510000/ml_scoring.c` - Neural network inference implementation
- `sqlite-src-3510000/nn_weights.h` - Trained model weights (generated by training script)

### Core Implementation - Query Optimization
- `sqlite-src-3510000/src/where.c` - Enhanced query planner with improved cost estimation
- **Covering Index Support:** Modified `whereLoopAddBtreeIndex()` to detect and prefer covering indexes
- **Cost Discounting:** Implements cost reduction (`pLoop->rCost` discount) for covering plans
- Modified functions: `bestIndex`, `sqlite3WhereBegin`, `whereLoopAddBtreeIndex`
- Enhanced cost estimation: `whereLoopAddAll`, `whereLoopAdjustCost`

### Core Implementation - Anomaly Detection
- Anomaly detection module with Z-Score analysis
- Isolation Forest implementation for cache access pattern detection
- Real-time anomaly flagging system

### Build System
- `sqlite-src-3510000/rebuild_after_changes.sh` - Build script to compile AI-enhanced SQLite

### Training Scripts
- `train_simple_nn_no_numpy.py` - Neural network training script (pure Python, no dependencies)
- `generate_synthetic_data.py` - Generates synthetic training data

### Benchmarking
- `benchmark_tpch.py` - TPC-H benchmark comparing default vs AI-enhanced SQLite
- `demonstrate_ai_benefits.py` - Cache efficiency demonstration
- `create_tpch_schema.sql` - TPC-H database schema
- `generate_tpch_sample_data.py` - TPC-H data generator
- `load_tpch_data.py` - Loads TPC-H data into SQLite
- `tpch_queries/` - TPC-H query files (10 queries)

### Documentation
- `PRESENTATION_SLIDES.md` - Complete presentation content

## Quick Start

### 1. Train the Neural Network
```bash
python generate_synthetic_data.py
python train_simple_nn_no_numpy.py
```
This generates `sqlite-src-3510000/nn_weights.h` with trained weights.

### 2. Build AI-Enhanced SQLite
```bash
cd sqlite-src-3510000
bash rebuild_after_changes.sh
```
This creates `sqlite3.exe` with ML cache management.

### 3. Run Benchmark
```bash
# Generate TPC-H data
python generate_tpch_sample_data.py
python load_tpch_data.py tpch_default.db
python load_tpch_data.py tpch_ai.db

# Run benchmark
python benchmark_tpch.py
```

## Results

**Complex Queries (Q1, Q3, Q5, Q6, Q7):**
- Default (LRU): 1,747 ms average
- AI-Enhanced: 285 ms average
- **Improvement: 83.7% faster**

**All Queries Average:**
- Default (LRU): 906 ms
- AI-Enhanced: 279 ms
- **Improvement: 69.2% faster**

## Technical Details

### Cache Management (ML-Based)
- **Neural Network:** 2-layer feedforward (4 inputs → 8 hidden → 1 output)
- **Training:** 10,000 synthetic samples, 200 epochs
- **Cache Size:** 2000 pages (for TPC-H benchmark)
- **Integration:** C implementation compiled into SQLite core

### Query Optimization
- **Covering Index Optimization:** Automatically detects when an index contains all columns needed by a query (covering index) and prefers it over table scans
- **Cost Discount Mechanism:** Modifies `whereLoopAddBtreeIndex()` to discount `pLoop->rCost` for covering plans, making them win over table scans
- **I/O Reduction:** Covering indexes eliminate the need for table lookups, significantly reducing disk I/O operations
- **Enhanced Query Planner:** Improved candidate loop plan generation
- **Cost Estimation:** Better algorithms for estimating execution costs with covering index awareness
- **Key Functions Modified:**
  - `bestIndex()` - Better index selection with covering index preference
  - `sqlite3WhereBegin()` - Improved query planning initialization
  - `whereLoopAddBtreeIndex()` - Enhanced B-tree index loop generation with cost discounting for covering indexes
  - `whereLoopAddAll()` - Better plan enumeration
  - `whereLoopAdjustCost()` - Improved cost calculation and adjustment
- **Benefits:** Faster queries on indexed workloads while preserving full SQL compatibility (no code changes required)

### Anomaly Detection
- **Z-Score Analysis:** Statistical method for detecting outliers in access patterns
- **Isolation Forest:** Machine learning algorithm for identifying anomalous cache access behaviors
- **Real-time Detection:** Continuous monitoring and flagging of unusual patterns
- **Benefits:** Identifies potential performance issues, security concerns, or unusual workload patterns

## Files Modified

### Cache Management
- `sqlite-src-3510000/src/pcache1.c` - Added ML-based eviction logic

### Query Optimization
- `sqlite-src-3510000/src/where.c` - Enhanced query planner and cost estimation
  - Modified `bestIndex()` for better index selection with covering index awareness
  - Enhanced `sqlite3WhereBegin()` for improved query planning
  - Updated `whereLoopAddBtreeIndex()` - **Key Enhancement:** Detects covering indexes and discounts `pLoop->rCost` for covering plans, automatically preferring them over table scans
  - Improved `whereLoopAddAll()` for comprehensive plan enumeration
  - Enhanced `whereLoopAdjustCost()` for accurate cost estimation
  - **Result:** Automatically selects covering indexes when available, reducing I/O without requiring SQL changes

### Build System
- `sqlite-src-3510000/rebuild_after_changes.sh` - Updated build script

## Files Created

### Cache Management
- `sqlite-src-3510000/ml_scoring.c` - ML inference code for cache scoring
- `sqlite-src-3510000/nn_weights.h` - Trained neural network weights

### Anomaly Detection
- Anomaly detection module with Z-Score implementation
- Isolation Forest algorithm for pattern detection

### Training & Data Generation
- `train_simple_nn_no_numpy.py` - Neural network training script
- `generate_synthetic_data.py` - Synthetic training data generator

### Benchmarking
- `benchmark_tpch.py` - TPC-H benchmark script
- `demonstrate_ai_benefits.py` - Cache efficiency demonstration
- TPC-H related scripts and query files

## Features

### 1. ML-Based Cache Management
- Intelligent page eviction using neural networks
- Multi-factor page scoring (frequency, recency, dirty status, references)
- Significant performance improvements for complex queries

### 2. Query Optimization
- **Covering Index Detection:** Automatically detects and prefers covering indexes (indexes containing all query columns)
- **I/O Reduction:** Eliminates table lookups by using covering indexes, significantly reducing disk I/O
- **Cost Discounting:** Modifies cost estimation to favor covering indexes over table scans
- Enhanced query planner with better execution plan selection
- Improved cost estimation algorithms
- Better index selection and join ordering
- Optimized candidate loop plan generation
- **Zero SQL Changes Required:** Works automatically, maintaining full compatibility

### 3. Anomaly Detection
- Z-Score statistical analysis for outlier detection
- Isolation Forest ML algorithm for pattern recognition
- Real-time monitoring of cache access patterns
- Identifies unusual behaviors that may indicate performance issues

## Requirements

- Python 3.x (standard library only - no external dependencies)
- GCC compiler (for building SQLite)
- MSYS2 (for Windows) or Unix-like system



